services:
  smelt-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: smelt-claude-dev
    volumes:
      # Mount source code
      - .:/workspace
      # Use named volumes for build artifacts (avoids cross-platform issues with macOS host)
      - cargo-target:/workspace/target
      - cargo-cache:/workspace/.cargo-cache
      - node-modules:/workspace/editors/vscode/node_modules
      # Mount host's git config for user identity
      - ${HOME}/.gitconfig:/root/.gitconfig.host:ro
      # Mount Docker git config that includes host config and adds push protection
      - ./docker/gitconfig:/root/.gitconfig:ro
      # Persist Claude Code settings across container restarts
      - claude-settings:/root/.claude
    environment:
      - RUST_BACKTRACE=1
      - CARGO_HOME=/workspace/.cargo-cache
    working_dir: /workspace
    # Increase memory limits for Rust compilation
    mem_limit: 8g
    memswap_limit: 8g
    # Keep container running
    stdin_open: true
    tty: true
    # Prevent network access to GitHub (optional - uncomment if desired)
    # networks:
    #   - isolated
    command: /bin/bash

# Uncomment to create an isolated network
# networks:
#   isolated:
#     driver: bridge
#     internal: true

volumes:
  cargo-target:
    driver: local
  cargo-cache:
    driver: local
  node-modules:
    driver: local
  claude-settings:
    driver: local
